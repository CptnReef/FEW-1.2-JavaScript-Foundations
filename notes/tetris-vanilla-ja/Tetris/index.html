<!doctype html>
<html>
  <head>
    <title></title>
    <style>
      .container {
        width: calc((20px + 2px) * 10);
        margin: auto;
        display: grid;
        grid-template-columns: 1fr;
      }
    </style>
  </head>
  <body>
    
    <div class="container">
        <div id="game-board"></div>
        <div id="controls" class="controls"></div>
    </div>

    <script>

      // ======================================================

      (() => {

        // All shapes and rotations
        // All Colors

        // ----------------------------------------------------
        // Defines a single square that displays with a color 
        // and border

        class Square {
          constructor(color) {
            this.colors = ['gray', 'red', 'green']
            this.color = color
            this.setup()
          }
          
          setup() {
            this.el = document.createElement('div')
            this.el.style.backgroundColor = this.color
            this.el.style.width = '20px'
            this.el.style.height = '20px'
            this.el.style.border = 'solid 1px #000'
          }

          setColor(newColor) {
            this.color = newColor
            this.el.style.backgroundColor = this.colors[this.color]
          }
        }

        // ----------------------------------------------------
        // Defines a block made of four squares 

        class Block {
          constructor(shapeIndex = 1) {
            this.shapeIndex = shapeIndex
            this.rotation = 0
            this.shapesArray = [
              // Empty
              [],
              // I
              [
              [[0,1,0,0], 
                [0,1,0,0], 
                [0,1,0,0], 
                [0,1,0,0]],
              
              [[0,0,0,0], 
              [1,1,1,1], 
              [0,0,0,0], 
              [0,0,0,0]]
              ]
            ]
          }
          
          rotate() {
            this.rotation = (this.rotation + 1) % this.shapesArray.length
          }

          getBlockArray() {
            return this.shapesArray[this.shapeIndex][this.rotation]
          }
        }

        // ----------------------------------------------------
        // Controls

        class Controls {
          constructor(game) {
            this.game = game
            this.setup()
          }

          setup() {
            this.el = document.createElement('div')
            this.el.style.display = 'flex'
            this.el.style.justifyContent = 'space-between'
            this.el.style.padding = '1em'

            this.leftButton = new ControlButton('Left')
            this.rightButton = new ControlButton('Right')
            this.rotateButton = new ControlButton('Rotate')
            this.downButton = new ControlButton('Down')

            this.el.appendChild(this.leftButton.el)
            this.el.appendChild(this.rightButton.el)
            this.el.appendChild(this.rotateButton.el)
            this.el.appendChild(this.downButton.el)

            this.leftButton.el.onclick = () => this.game.moveLeft()
            this.rightButton.el.onclick = () => this.game.moveRight()
            this.rotateButton.el.onclick = () => this.game.rotate()
            this.downButton.el.onclick = () => this.game.moveDown()
          }
        }

        // ----------------------------------------------------
        // ControlButton 

        class ControlButton {
          constructor(title) {
            this.title = title
            this.el = document.createElement('button')
            this.el.style.border = '1px solid'
            this.el.style.width = '40px'
            this.el.style.height = '40px'
            this.el.style.textAlign = 'center'
            this.el.style.display = 'block'
            this.el.innerHTML = title
          }
        }
        
        // ----------------------------------------------------
        // Draws a grid of squares 

        class GameBoard {
          constructor(rows, cols) {
            this.el = document.getElementById('game-board')
            this.el.style.display = 'grid'
            this.el.style.gridTemplateColumns = 'repeat(10, 1fr)'
            this.el.style.justifyContent = 'center'
            this.el.style.width = `${(20 + 1) * 10}px`
            this.el.style.margin = 'auto'
            this.board = []
            this.rows = rows
            this.cols = cols
            this.setup();
          }
          
          setup() {
            let boardStr = ''
            for(let row = 0; row < this.rows; row += 1) {
              let rowArray = [];
              let color = `hsl(${360 / this.rows * row}, 100%, 50%)`
              for(let col = 0; col < this.cols; col += 1) {
                let square = new Square(color)
                this.el.append(square.el)
                rowArray.push(square)
              }
              this.board.push(rowArray)
            }
          }

          render(array) {
            for (let row = 0; row < this.rows; row += 1) {
              for (let col = 0; col < this.cols; col += 1) {
                this.board[row][col].setColor(array[row][col])
              }
            }
          }
        }
        
        // ----------------------------------------------------
        // Game - Manages Game Objects 

        class Game {
          constructor() {
            // Define some variables 
            this.rows = 18
            this.cols = 10
            // Make a new Game Board
            this.gameBoard = new GameBoard(this.rows, this.cols)
            // Build the board array
            this.boardArray = this.makeBoardArray()
            // Make a Block
            this.block = new Block()
            this.blockX = 4
            this.blockY = 7

            this.controls = new Controls(this)
            document.getElementById('controls').appendChild(this.controls.el)

            this.render()
          }

          makeBoardArray() {
            const boardArray = []
            for (let row = 0; row < this.rows; row += 1) {
              const rowArray = []
              for(let col = 0; col < this.cols; col += 1) {
                rowArray.push(0)
              }
              boardArray.push(rowArray)
            }
            return boardArray
          }

          mapBlockToBoard() {
            const blockArray = this.block.getBlockArray()
            for (let row = 0; row < blockArray.length; row += 1) {
              for (let col = 0; col < blockArray[0].length; col += 1) {
                if (blockArray[row][col] !== 0) {
                  this.boardArray[row + this.blockY][col + this.blockX] = this.block.shapeIndex
                } else {
                  this.boardArray[row + this.blockY][col + this.blockX] = 0
                }
              }
            }
          }

          canMove(x, y) {
            // Check if the block overlaps filled board squares
            const blockArray = this.block.getBlockArray()
            for (let row = 0; row < blockArray.length; row += 1) {
              for (let col = 0; col < blockArray[row].length; col += 1) {
                const testX = x + col
                const textY = y + row
                if (blockArray[row][col] && this.boardArray[testY][testX]) {
                  return false
                }
              }
            }
            return true
          }

          moveLeft() {
            console.log('move left')
            if (canMove(this.blockX - 1, this.blockY)) {
              this.blockX -= 1
              this.render()
            }
          }

          moveRight() {
            console.log('move right')
            if (canMove(this.blockX + 1, this.blockY)) {
              this.blockX += 1
              this.render()
            }
          }

          moveDown() {
            console.log('move down')
            if (canMove(this.blockX, this.blockY + 1)) {
              this.blockY += 1
              this.render()
            }
          }

          rotate() {
            console.log('rotate')
            this.block.rotate()
          }

          render() {
            this.mapBlockToBoard()
            this.gameBoard.render(this.boardArray, this.block)
          }
        }

        new Game()
        
      })()
    </script>
  </body>
</html>